const {
  SlashCommandBuilder,
  EmbedBuilder,
  ActionRowBuilder,
  StringSelectMenuBuilder,
  ChannelType,
  PermissionsBitField
} = require("discord.js");

const ROL_FISCAL = "1399106688904073256";

module.exports = {
  data: new SlashCommandBuilder()
    .setName("soporte-pgn")
    .setDescription("Sistema de atenciÃ³n ciudadana - PGN"),

  async execute(interaction) {

    const embed = new EmbedBuilder()
      .setTitle("âš–ï¸ ProcuradurÃ­a General de la NaciÃ³n")
      .setDescription(
        "ğŸ›ï¸ **Ministerio PÃºblico de la RepÃºblica de PanamÃ¡**\n\n" +
        "Seleccione el tipo de solicitud que desea realizar:"
      )
      .setColor(0x2c3e50)
      .setFooter({ text: "PGN - Sistema Oficial de AtenciÃ³n" })
      .setTimestamp();

    const menu = new StringSelectMenuBuilder()
      .setCustomId("pgn_select")
      .setPlaceholder("Seleccione una opciÃ³n")
      .addOptions([
        {
          label: "Denuncia",
          description: "Presentar una denuncia formal",
          value: "denuncia",
          emoji: "ğŸ“„"
        },
        {
          label: "Asistencia Fiscal",
          description: "Solicitar orientaciÃ³n legal",
          value: "asistencia",
          emoji: "âš–ï¸"
        },
        {
          label: "Queja contra funcionario",
          description: "Reportar conducta indebida",
          value: "queja",
          emoji: "ğŸ›¡ï¸"
        },
        {
          label: "Seguimiento de caso",
          description: "Consultar estado de proceso",
          value: "seguimiento",
          emoji: "ğŸ“‘"
        }
      ]);

    const row = new ActionRowBuilder().addComponents(menu);

    await interaction.reply({
      embeds: [embed],
      components: [row],
      ephemeral: true
    });
  },

  async select(interaction) {

    const tipo = interaction.values[0];

    const canal = await interaction.guild.channels.create({
      name: `pgn-${interaction.user.username}`,
      type: ChannelType.GuildText,
      permissionOverwrites: [
        {
          id: interaction.guild.id,
          deny: [PermissionsBitField.Flags.ViewChannel]
        },
        {
          id: interaction.user.id,
          allow: [PermissionsBitField.Flags.ViewChannel, PermissionsBitField.Flags.SendMessages]
        },
        {
          id: ROL_FISCAL,
          allow: [PermissionsBitField.Flags.ViewChannel, PermissionsBitField.Flags.SendMessages]
        }
      ]
    });

    let contenido = "";

    if (tipo === "denuncia") {
      contenido =
`## ğŸ“„ Plantilla de Denuncia ante el Ministerio PÃºblico

### ğŸ“ Lugar y fecha
ğŸ—“ï¸ [Ciudad], [dÃ­a] de [mes] de [aÃ±o]

### ğŸ“‘ Asunto
ğŸ“ Denuncia por _________

### ğŸ‘¤ 1. Datos del denunciante
ğŸ†” Nombre completo:
ğŸªª CÃ©dula/Pasaporte:
ğŸ“ Contacto:

### ğŸ•µï¸ 2. Datos del denunciado
ğŸ†” Nombre:
ğŸªª CÃ©dula:
ğŸ’¼ Cargo:

### ğŸ“– 3. DescripciÃ³n de los hechos
âœï¸ Describa detalladamente lo ocurrido.

### ğŸ“‚ 5. Pruebas adjuntas
ğŸ“ Adjunte pruebas si posee.

### ğŸ“¢ 6. PeticiÃ³n
Solicito que el Ministerio PÃºblico inicie investigaciÃ³n correspondiente.

âœï¸ Firma del denunciante`;
    }

    if (tipo === "asistencia") {
      contenido =
`âš–ï¸ **Solicitud de Asistencia Fiscal**

Explique detalladamente su situaciÃ³n legal para recibir orientaciÃ³n del fiscal asignado.`;
    }

    if (tipo === "queja") {
      contenido =
`ğŸ›¡ï¸ **Queja contra funcionario**

Indique nombre del funcionario y describa los hechos.`;
    }

    if (tipo === "seguimiento") {
      contenido =
`ğŸ“‘ **Seguimiento de caso**

Indique nÃºmero de expediente o informaciÃ³n relacionada.`;
    }

    const embedTicket = new EmbedBuilder()
      .setTitle("ğŸ“‚ Ticket PGN Abierto")
      .setDescription(`ğŸ‘¤ Usuario: ${interaction.user}\nğŸ“Œ Tipo: ${tipo}`)
      .setColor(0x34495e)
      .setTimestamp();

    await canal.send({
      content: `<@&${ROL_FISCAL}>`,
      embeds: [embedTicket]
    });

    await canal.send(contenido);

    await interaction.update({
      content: "âœ… Ticket creado correctamente.",
      embeds: [],
      components: []
    });
  }
};
